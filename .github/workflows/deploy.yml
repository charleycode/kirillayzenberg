name: Deploy Static Site to S3

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout source code
        uses: actions/checkout@v3

      - name: üß± Install dependencies
        run: npm install

      - name: ‚öôÔ∏è Build and export the site
        run: |
          npm run build

      - name: üöÄ Sync build output to S3
        uses: jakejarvis/s3-sync-action@v0.5.1
        with:
          args: --delete
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          SOURCE_DIR: ./out

      - name: üîÅ Apply redirects from redirects.json
        run: |
          # Fail if redirects.json doesn't exist
          if [ ! -f redirects.json ]; then
            echo "‚ùå redirects.json not found. Skipping redirects."
            exit 0
          fi

          echo "üìÑ Found redirects.json. Applying redirect rules..."

          # Loop through JSON entries and apply redirect metadata
          cat redirects.json | jq -r 'to_entries[] | "\(.key) \(.value)"' | while read from to; do
            echo "‚û°Ô∏è Redirecting $from ‚Üí $to"
            aws s3 cp s3://$AWS_S3_BUCKET/index.html s3://$AWS_S3_BUCKET${from}/index.html \
              --website-redirect "$to" \
              --metadata-directive REPLACE \
              --acl public-read \
              --content-type text/html
          done
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: üîÑ Invalidate CloudFront cache (optional)
        if: ${{ env.CLOUDFRONT_DISTRIBUTION_ID != '' }}
        uses: chetan/invalidate-cloudfront-action@v2
        env:
          CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
          DISTRIBUTION: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
          PATHS: "/*"
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
